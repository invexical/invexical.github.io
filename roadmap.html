<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invexic Trainer | Passion Project</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&family=Balthazar&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* --- GLOBAL VARIABLES --- */
        :root {
            --bg-dark: #0a0a0a;
            --bg-card: #141414;
            --bg-hover: #1f1f1f;
            --border: #2a2a2a;
            --accent: #20C997;
            --accent-dim: rgba(32, 201, 151, 0.1);
            --blue: #19A4FF;
            --text-main: #eeeeee;
            --text-muted: #888888;
        }

        * { box-sizing: border-box; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow-x: hidden;
        }

        /* --- BACKGROUND EFFECT --- */
        body::before {
            content: '';
            position: fixed;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at center, rgba(32, 201, 151, 0.03), transparent 40%);
            z-index: -1;
            animation: rotateBg 40s linear infinite;
            pointer-events: none;
        }
        @keyframes rotateBg { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- NAVIGATION --- */
        nav {
            border-bottom: 1px solid var(--border);
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
        }
        .nav-content {
            max-width: 1200px; margin: 0 auto; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-family: 'Balthazar', serif; font-size: 1.5rem; color: var(--accent); font-weight: bold; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-btn {
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; font-size: 0.95rem; font-weight: 600;
            transition: 0.2s;
        }
        .nav-btn:hover, .nav-btn.active { color: white; }
        
        .user-pill {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex; align-items: center; gap: 8px;
            cursor: pointer;
        }
        .xp-text { color: var(--accent); font-weight: 700; font-family: 'JetBrains Mono', monospace; }

        /* --- LAYOUTS --- */
        .view-section { display: none; padding: 40px 20px; max-width: 1200px; margin: 0 auto; }
        .view-section.active { display: block; }

        /* --- GUIDE VIEW (USACO Style) --- */
        .guide-container { display: grid; grid-template-columns: 250px 1fr; gap: 40px; }
        
        @media(max-width: 768px) { .guide-container { grid-template-columns: 1fr; } }

        .guide-sidebar { position: sticky; top: 100px; height: fit-content; }
        .guide-nav-item {
            padding: 10px; color: var(--text-muted); cursor: pointer;
            border-left: 2px solid transparent; transition: 0.2s;
        }
        .guide-nav-item:hover { color: white; background: var(--bg-hover); }
        .guide-nav-item.active { color: var(--accent); border-left-color: var(--accent); background: var(--accent-dim); }

        .topic-section { margin-bottom: 40px; animation: fadeIn 0.5s ease; }
        .topic-header { font-size: 1.5rem; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        
        /* The Problem List Table */
        .problem-list { display: flex; flex-direction: column; gap: 8px; }
        .problem-row {
            display: grid;
            grid-template-columns: 40px 1fr 100px 40px;
            align-items: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .problem-row:hover { border-color: var(--blue); transform: translateX(5px); }
        
        .status-icon { color: #333; display: flex; justify-content: center; }
        .status-icon.solved { color: var(--accent); }
        
        .prob-info { display: flex; flex-direction: column; }
        .prob-title { font-weight: 600; color: var(--text-main); }
        .prob-sub { font-size: 0.8rem; color: var(--text-muted); }

        .diff-badge {
            font-size: 0.75rem; padding: 4px 8px; border-radius: 4px;
            text-align: center; font-weight: 700; background: #222; color: #888;
        }
        .diff-badge.easy { background: rgba(32, 201, 151, 0.1); color: var(--accent); }
        .diff-badge.med { background: rgba(25, 164, 255, 0.1); color: var(--blue); }
        .diff-badge.hard { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

        /* --- PROBLEM DETAIL OVERLAY (Reused) --- */
        .detail-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            z-index: 2000; display: flex; justify-content: center; align-items: flex-start;
            overflow-y: auto; padding: 40px 20px;
        }
        .detail-overlay.hidden { display: none; }
        
        .detail-container {
            background: #0d0d0d; width: 100%; max-width: 900px;
            border-radius: 20px; border: 1px solid var(--border);
            padding: 40px; margin: auto 0; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        .close-btn { 
            position: absolute; top: 20px; right: 20px; 
            background: #222; border: none; color: white; 
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
        }

        .question-box { font-family: 'Balthazar', serif; font-size: 1.3rem; margin-bottom: 30px; line-height: 1.6; }
        
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 40px; }
        .opt-box {
            background: #161616; padding: 15px; border-radius: 8px; border: 1px solid #333;
            cursor: pointer; display: flex; gap: 10px; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .opt-box:hover:not(.disabled) { border-color: var(--blue); background: #1a1a1a; }
        .opt-box.correct { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        .opt-box.incorrect { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; color: #ef4444; }
        .opt-box.disabled { cursor: default; }
        
        /* Analysis Dashboard */
        .analysis-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; border-top: 1px solid var(--border); padding-top: 30px; }
        .info-card { background: #111; border: 1px solid var(--border); padding: 20px; border-radius: 12px; }
        .info-card h4 { color: #888; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- NAV -->
    <nav>
        <div class="nav-content">
            <div class="brand">invexic</div>
            <div class="nav-links">
                <button class="nav-btn" onclick="switchView('guide')">Guide</button>
                <button class="nav-btn" onclick="switchView('home')">Browse</button>
                <div class="user-pill">
                    <i data-lucide="trophy" size="14" color="#FACC15"></i>
                    <span id="userXp" class="xp-text">0 XP</span>
                </div>
                <div class="user-pill" id="loginBtn">
                    <i data-lucide="user" size="14"></i>
                    <span id="loginText">Guest</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- VIEW: GUIDE (USACO STYLE) -->
    <div id="guideView" class="view-section active">
        <div class="guide-container">
            <!-- Sidebar -->
            <div class="guide-sidebar">
                <div style="font-weight: 700; margin-bottom: 15px; color: white;">Curriculum</div>
                <div class="guide-nav-item active" onclick="scrollToTopic('algebra')">Algebra Basics</div>
                <div class="guide-nav-item" onclick="scrollToTopic('geometry')">Geometry</div>
                <div class="guide-nav-item" onclick="scrollToTopic('combo')">Combinatorics</div>
            </div>

            <!-- Content -->
            <div class="guide-content" id="guideContent">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <!-- VIEW: HOME (The Grid) -->
    <div id="homeView" class="view-section">
        <h2 style="margin-bottom: 20px;">All Problems</h2>
        <div id="problemGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
            <!-- Injected via JS -->
        </div>
    </div>

    <!-- PROBLEM MODAL -->
    <div id="detailOverlay" class="detail-overlay hidden">
        <div class="detail-container">
            <button class="close-btn" onclick="closeDetail()"><i data-lucide="x"></i></button>
            <div id="detailContent"></div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- CONFIG ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = __app_id || 'default-app';

        let currentUser = null;
        let solvedProblems = new Set();
        let currentXP = 0;

        // --- PROBLEM DATA (Expanded with Topics) ---
        const problems = [
            { id: "p1", number: 1, title: "The Rate Race", difficulty: 6, topic: "algebra", tags: ["Rate", "Time"], solution: "Andy travels north at 8mph...", options: ["3:30", "3:45", "4:00", "4:15", "4:30"], answerIndex: 4 },
            { id: "p2", number: 2, title: "Nut Mixes", difficulty: 9, topic: "algebra", tags: ["Mixtures", "Percent"], solution: "A box contains 10 pounds...", options: ["3.5", "4", "4.5", "5", "6"], answerIndex: 1 },
            { id: "p3", number: 3, title: "Triangle Inequality", difficulty: 14, topic: "geometry", tags: ["Inequality", "Triangles"], solution: "Lengths of sides...", options: ["2025", "2026", "3012", "3037", "4050"], answerIndex: 3 },
            { id: "p5", number: 5, title: "Integer Sequence", difficulty: 30, topic: "algebra", tags: ["Sequences"], solution: "Consider sequence...", options: ["5", "15", "16", "44", "45"], answerIndex: 4 },
            { id: "p6", number: 6, title: "Hexagon Angles", difficulty: 28, topic: "geometry", tags: ["Polygons"], solution: "Equilateral triangle...", options: ["80", "90", "100", "110", "120"], answerIndex: 2 },
            { id: "p9", number: 9, title: "Cubic Roots", difficulty: 45, topic: "algebra", tags: ["Functions"], solution: "f(x) = 100x^3...", options: ["1", "2", "3", "4", ">4"], answerIndex: 2 },
        ];

        const curriculum = [
            { id: "algebra", title: "Algebra & Number Theory", problems: ["p1", "p2", "p5", "p9"] },
            { id: "geometry", title: "Geometry & Spatial", problems: ["p3", "p6"] },
            { id: "combo", title: "Combinatorics", problems: [] } // Placeholder
        ];

        // --- AUTH & INIT ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginText').innerText = "User " + user.uid.substring(0,4);
                await loadProgress();
            }
            renderApp();
        });

        initAuth();

        // --- FIRESTORE LOGIC ---
        async function loadProgress() {
            if(!currentUser) return;
            const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data');
            try {
                const snap = await getDoc(userRef);
                if (snap.exists()) {
                    const data = snap.data();
                    solvedProblems = new Set(data.solved || []);
                    currentXP = data.xp || 0;
                    document.getElementById('userXp').innerText = `${currentXP} XP`;
                } else {
                    // Create profile
                    await setDoc(userRef, { solved: [], xp: 0 });
                }
            } catch (e) { console.error("Load error:", e); }
        }

        async function saveProgress(problemId, difficulty) {
            if(!currentUser || solvedProblems.has(problemId)) return;
            
            solvedProblems.add(problemId);
            const xpGain = Math.max(10, difficulty); // XP formula
            currentXP += xpGain;

            // UI Update immediately
            document.getElementById('userXp').innerText = `${currentXP} XP`;
            renderApp(); // Re-render to show checkmarks

            const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data');
            try {
                await updateDoc(userRef, {
                    solved: arrayUnion(problemId),
                    xp: currentXP // Simple increment logic
                });
            } catch (e) { console.error("Save error:", e); }
        }

        // --- RENDERING ---
        function renderApp() {
            renderGuide();
            renderGrid();
            lucide.createIcons();
        }

        function getDiffClass(d) {
            if(d < 20) return 'easy';
            if(d < 40) return 'med';
            return 'hard';
        }
        
        function getDiffLabel(d) {
            if(d < 20) return 'Easy';
            if(d < 40) return 'Normal';
            return 'Hard';
        }

        // 1. Render Guide (USACO Style List)
        function renderGuide() {
            const container = document.getElementById('guideContent');
            container.innerHTML = curriculum.map(section => {
                const sectionProbs = section.problems.map(pid => problems.find(p => p.id === pid)).filter(Boolean);
                
                return `
                <div class="topic-section" id="topic-${section.id}">
                    <div class="topic-header">${section.title}</div>
                    <div class="problem-list">
                        ${sectionProbs.map(p => {
                            const isSolved = solvedProblems.has(p.id);
                            return `
                            <div class="problem-row" onclick="window.openDetail('${p.id}')">
                                <div class="status-icon ${isSolved ? 'solved' : ''}">
                                    ${isSolved ? '<i data-lucide="check-circle-2"></i>' : '<i data-lucide="circle"></i>'}
                                </div>
                                <div class="prob-info">
                                    <span class="prob-title">${p.title}</span>
                                    <span class="prob-sub">${p.tags.join(', ')}</span>
                                </div>
                                <div class="diff-badge ${getDiffClass(p.difficulty)}">
                                    ${getDiffLabel(p.difficulty)}
                                </div>
                                <div style="color:#444"><i data-lucide="chevron-right"></i></div>
                            </div>
                            `
                        }).join('')}
                        ${sectionProbs.length === 0 ? '<div style="color:#555; font-style:italic;">Coming soon...</div>' : ''}
                    </div>
                </div>
                `;
            }).join('');
        }

        // 2. Render Grid (Card Style)
        function renderGrid() {
            const grid = document.getElementById('problemGrid');
            grid.innerHTML = problems.map(p => {
                const isSolved = solvedProblems.has(p.id);
                return `
                <div class="problem-row" style="display:block; padding:20px; border-color:${isSolved ? 'var(--accent)' : 'var(--border)'}" onclick="window.openDetail('${p.id}')">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span style="color:var(--blue); font-weight:bold;">#${p.number}</span>
                        ${isSolved ? '<i data-lucide="check" size="16" color="var(--accent)"></i>' : ''}
                    </div>
                    <h3 style="margin:0 0 10px 0;">${p.title}</h3>
                    <span class="diff-badge ${getDiffClass(p.difficulty)}">${getDiffLabel(p.difficulty)}</span>
                </div>
                `;
            }).join('');
        }

        // --- GLOBAL WINDOW FUNCTIONS ---
        window.switchView = (viewName) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewName + 'View').classList.add('active');
        };

        window.scrollToTopic = (id) => {
            document.getElementById(`topic-${id}`)?.scrollIntoView({ behavior: 'smooth' });
        };

        window.openDetail = (id) => {
            const p = problems.find(x => x.id === id);
            if(!p) return;

            const optionsHtml = p.options.map((opt, i) => `
                <div class="opt-box" onclick="window.checkAnswer('${p.id}', ${i}, this)">
                    <span style="color:#666; font-weight:bold;">${String.fromCharCode(65+i)}</span>
                    <span>${opt}</span>
                </div>
            `).join('');

            document.getElementById('detailContent').innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;">
                    <div>
                        <h2 style="margin:0;">${p.title}</h2>
                        <span style="color:#666;">Difficulty: ${p.difficulty}/100</span>
                    </div>
                    <div style="font-size:2rem; font-weight:800; color:var(--accent-dim); color: #333;">${p.number}</div>
                </div>

                <div class="question-box">${p.solution}</div> <!-- Using solution field as question text for demo -->
                
                <div class="options-grid" id="optGrid">${optionsHtml}</div>

                <div class="analysis-dashboard">
                    <div class="info-card">
                        <h4><i data-lucide="tag"></i> Concepts</h4>
                        <div>${p.tags.map(t => `<span style="background:#222; padding:4px 8px; border-radius:4px; font-size:0.8rem; margin-right:5px; display:inline-block;">${t}</span>`).join('')}</div>
                    </div>
                    <div class="info-card">
                        <h4><i data-lucide="award"></i> Reward</h4>
                        <div style="font-size:1.5rem; color:var(--accent); font-weight:bold;">+${Math.max(10, p.difficulty)} XP</div>
                    </div>
                </div>
            `;
            
            document.getElementById('detailOverlay').classList.remove('hidden');
            lucide.createIcons();
            if(MathJax.typesetPromise) MathJax.typesetPromise();
        };

        window.checkAnswer = (pid, idx, el) => {
            const p = problems.find(x => x.id === pid);
            const grid = document.getElementById('optGrid');
            
            // Disable clicks
            grid.style.pointerEvents = 'none';
            grid.querySelectorAll('.opt-box').forEach(b => b.classList.add('disabled'));

            if(idx === p.answerIndex) {
                el.classList.add('correct');
                // Trigger Save
                saveProgress(pid, p.difficulty);
                // Confetti could go here
            } else {
                el.classList.add('incorrect');
                grid.children[p.answerIndex].classList.add('correct');
            }
        };

        window.closeDetail = () => {
            document.getElementById('detailOverlay').classList.add('hidden');
        };

    </script>
</body>
</html>
