<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invexic Trainer | Passion Project</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&family=Balthazar&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        /* --- GLOBAL VARIABLES --- */
        :root {
            --bg-dark: #0a0a0a;
            --bg-card: #141414;
            --bg-hover: #1f1f1f;
            --border: #2a2a2a;
            --accent: #20C997;
            --accent-dim: rgba(32, 201, 151, 0.1);
            --blue: #19A4FF;
            --blue-dim: rgba(25, 164, 255, 0.1);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.1);
            --text-main: #eeeeee;
            --text-muted: #888888;
        }

        * { box-sizing: border-box; }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow-x: hidden;
        }

        /* --- BACKGROUND EFFECT --- */
        body::before {
            content: '';
            position: fixed;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at center, rgba(32, 201, 151, 0.03), transparent 40%);
            z-index: -1;
            animation: rotateBg 60s linear infinite;
            pointer-events: none;
        }
        @keyframes rotateBg { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- NAVIGATION --- */
        nav {
            border-bottom: 1px solid var(--border);
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
        }
        .nav-content {
            max-width: 1400px; margin: 0 auto; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand { font-family: 'Balthazar', serif; font-size: 1.5rem; color: var(--accent); font-weight: bold; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-btn {
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; font-size: 0.95rem; font-weight: 600;
            transition: 0.2s;
        }
        .nav-btn:hover, .nav-btn.active { color: white; }
        
        .user-pill {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex; align-items: center; gap: 8px;
            cursor: pointer;
        }
        .xp-text { color: var(--accent); font-weight: 700; font-family: 'JetBrains Mono', monospace; }

        /* --- LAYOUTS --- */
        .view-section { display: none; padding: 40px 20px; max-width: 1400px; margin: 0 auto; }
        .view-section.active { display: block; }

        /* --- GUIDE VIEW (USACO Style) --- */
        .guide-container { display: grid; grid-template-columns: 280px 1fr; gap: 50px; }
        
        @media(max-width: 850px) { .guide-container { grid-template-columns: 1fr; } }

        /* Sidebar Styling */
        .guide-sidebar { 
            position: sticky; top: 100px; height: fit-content; 
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px;
        }
        .guide-section-title {
            font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;
            color: var(--text-muted); margin: 20px 0 10px 0; font-weight: 700;
        }
        .guide-section-title:first-child { margin-top: 0; }
        
        .guide-nav-item {
            padding: 10px 12px; color: #ccc; cursor: pointer;
            border-radius: 6px; transition: 0.2s; font-size: 0.95rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .guide-nav-item:hover { background: var(--bg-hover); color: white; }
        .guide-nav-item.active { background: var(--accent-dim); color: var(--accent); font-weight: 600; }
        
        /* Count badge in sidebar */
        .count-badge { font-size: 0.75rem; background: #222; padding: 2px 6px; border-radius: 4px; color: #666; }

        /* Content Styling */
        .topic-section { margin-bottom: 50px; scroll-margin-top: 100px; }
        .topic-header { font-size: 1.8rem; margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 15px; display: flex; align-items: center; gap: 15px; }
        .topic-icon { color: var(--accent); }
        
        /* The Problem List Table */
        .problem-list { display: flex; flex-direction: column; gap: 10px; }
        .problem-row {
            display: grid;
            /* Status | Title | Tags | Diff | Arrow */
            grid-template-columns: 40px 1fr 1.5fr 100px 40px;
            align-items: center;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 16px;
            border-radius: 10px;
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
        }
        .problem-row:hover { border-color: var(--blue); transform: translateX(4px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        
        @media(max-width: 700px) {
            .problem-row { grid-template-columns: 40px 1fr 40px; }
            .prob-tags-col { display: none; } /* Hide tags on mobile */
        }

        .status-icon { color: #333; display: flex; justify-content: center; }
        .status-icon.solved { color: var(--accent); }
        
        .prob-info { display: flex; flex-direction: column; gap: 4px; }
        .prob-title { font-weight: 600; color: var(--text-main); font-size: 1.05rem; }
        
        .prob-tags-col { display: flex; gap: 6px; flex-wrap: wrap; }
        .mini-tag { font-size: 0.75rem; color: #888; background: #1a1a1a; padding: 3px 8px; border-radius: 4px; border: 1px solid #333; }

        /* Difficulty Badges */
        .diff-badge {
            font-size: 0.8rem; padding: 4px 10px; border-radius: 20px;
            text-align: center; font-weight: 700; background: #222; color: #888;
            width: fit-content; justify-self: center;
        }
        .diff-badge.easy { background: var(--accent-dim); color: var(--accent); }
        .diff-badge.normal { background: var(--blue-dim); color: var(--blue); }
        .diff-badge.hard { background: var(--red-dim); color: var(--red); }

        /* --- PROBLEM DETAIL OVERLAY --- */
        .detail-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            z-index: 2000; display: flex; justify-content: center; align-items: flex-start;
            overflow-y: auto; padding: 40px 20px;
        }
        .detail-overlay.hidden { display: none; }
        
        .detail-container {
            background: #0d0d0d; width: 100%; max-width: 950px;
            border-radius: 20px; border: 1px solid var(--border);
            padding: 40px; margin: auto 0; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .close-btn { 
            position: absolute; top: 20px; right: 20px; 
            background: transparent; border: 1px solid var(--border); color: #888; 
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .close-btn:hover { border-color: white; color: white; background: #222; }

        .question-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .question-box { font-family: 'Balthazar', serif; font-size: 1.35rem; margin-bottom: 40px; line-height: 1.6; color: #f0f0f0; }
        
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 50px; }
        .opt-box {
            background: #161616; padding: 16px; border-radius: 8px; border: 1px solid #333;
            cursor: pointer; display: flex; gap: 12px; align-items: center; justify-content: center;
            transition: 0.2s; font-size: 1.1rem;
        }
        .opt-box:hover:not(.disabled) { border-color: var(--blue); background: #1a1a1a; transform: translateY(-2px); }
        .opt-box.correct { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        .opt-box.incorrect { background: var(--red-dim); border-color: var(--red); color: var(--red); }
        .opt-box.disabled { cursor: default; }
        
        /* Analysis Dashboard */
        .analysis-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; border-top: 1px solid var(--border); padding-top: 40px; }
        .info-card { background: #111; border: 1px solid var(--border); padding: 24px; border-radius: 12px; }
        .info-card h4 { color: #888; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; font-weight: 700; }
        .trap-card { border-color: rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.05); }
        .trap-card h4 { color: var(--red); }
    </style>
</head>
<body>

    <!-- NAV -->
    <nav>
        <div class="nav-content">
            <div class="brand">invexic</div>
            <div class="nav-links">
                <button class="nav-btn active" onclick="switchView('guide')">Curriculum</button>
                <div class="user-pill">
                    <i data-lucide="trophy" size="14" color="#FACC15"></i>
                    <span id="userXp" class="xp-text">0 XP</span>
                </div>
                <div class="user-pill" id="loginBtn">
                    <i data-lucide="user" size="14"></i>
                    <span id="loginText">Guest</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- VIEW: GUIDE (USACO STYLE) -->
    <div id="guideView" class="view-section active">
        <div class="guide-container">
            <!-- Sidebar -->
            <div class="guide-sidebar">
                <div class="guide-section-title">Core Curriculum</div>
                <div class="guide-nav-item active" onclick="scrollToTopic('algebra')">
                    <span>Algebra & Number Theory</span>
                    <span class="count-badge">7</span>
                </div>
                <div class="guide-nav-item" onclick="scrollToTopic('geometry')">
                    <span>Geometry</span>
                    <span class="count-badge">4</span>
                </div>
                <div class="guide-nav-item" onclick="scrollToTopic('combo')">
                    <span>Combinatorics & Logic</span>
                    <span class="count-badge">2</span>
                </div>
                
                <div class="guide-section-title">Your Stats</div>
                <div style="padding: 10px; color: #888; font-size: 0.9rem;">
                    Problems Solved: <span id="solvedCount" style="color: white; font-weight: bold;">0</span>/13
                </div>
            </div>

            <!-- Content -->
            <div class="guide-content" id="guideContent">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <!-- PROBLEM MODAL -->
    <div id="detailOverlay" class="detail-overlay hidden">
        <div class="detail-container">
            <button class="close-btn" onclick="closeDetail()"><i data-lucide="x"></i></button>
            <div id="detailContent"></div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- CONFIG ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = __app_id || 'default-app';

        let currentUser = null;
        let solvedProblems = new Set();
        let currentXP = 0;

        // --- PROBLEM DATA (Updated with AMC 10A 2025 Set) ---
        const problems = [
            {
                id: "AMC10A_2025_P1",
                contest: "AMC 10A 2025",
                problemNumber: 1,
                difficulty: 6,
                topic: "algebra",
                answerIndex: 4,
                idealTime: { beginner: 90, intermediate: 40, experienced: 20 },
                tags: ["Rate", "Distance-Rate-Time", "Equation Setup"],
                coreIdeas: "Accounting for Betsy's 1-hour delay.",
                techniques: "Distance-rate-time setup. Algebraic substitution.",
                errorProneSteps: "Failing to account for the one hour delay.",
                solution: "Andy and Betsy both live in Mathville. Andy leaves Mathville on his bicycle at $1{:}30$ traveling due north at a steady $8$ miles per hour. Betsy leaves at $2{:}30$, traveling due east at a steady $12$ miles per hour. At what time will they be exactly the same distance from their starting point?",
                options: ["3:30 PM", "3:45 PM", "4:00 PM", "4:15 PM", "4:30 PM"]
            },
            {
                id: "AMC10A_2025_P2",
                contest: "AMC 10A 2025",
                problemNumber: 2,
                difficulty: 9,
                topic: "algebra",
                answerIndex: 1,
                idealTime: { beginner: 60, intermediate: 30, experienced: 20 },
                tags: ["Mixtures", "Weighted Mean", "Percentages"],
                coreIdeas: "Using weighted means properly.",
                techniques: "Set up a linear equation for the second mixture's weight.",
                errorProneSteps: "Finding the number of pounds of the second mixture instead of cashews.",
                solution: "A box contains $10$ pounds of a nut mix that is $50\%$ peanuts, $20\%$ cashews, and $30\%$ almonds. A second nut mix containing $20\%$ peanuts, $40\%$ cashews, and $40\%$ almonds is added to the box resulting in a new nut mix that is $40\%$ peanuts. How many pounds of cashews are now in the box?",
                options: ["3.5", "4", "4.5", "5", "6"]
            },
            {
                id: "AMC10A_2025_P3",
                contest: "AMC 10A 2025",
                problemNumber: 3,
                difficulty: 14,
                topic: "geometry",
                answerIndex: 3,
                idealTime: { beginner: 90, intermediate: 45, experienced: 25 },
                tags: ["Casework", "Triangle Inequality", "Isosceles Triangle"],
                coreIdeas: "Realizing that the longest side being $2025$ results in two scenarios.",
                techniques: "Solve inequalities for both cases, avoid double-counting.",
                errorProneSteps: "Forgetting or double-counting equilateral case.",
                solution: "How many isosceles triangles are there with positive area whose side lengths are all positive integers and whose longest side has length $2025$?",
                options: ["2025", "2026", "3012", "3037", "4050"]
            },
            {
                id: "AMC10A_2025_P4",
                contest: "AMC 10A 2025",
                problemNumber: 4,
                difficulty: 26,
                topic: "algebra",
                answerIndex: 1,
                idealTime: { beginner: 180, intermediate: 120, experienced: 60 },
                tags: ["Mean", "Average", "System of Equations"],
                coreIdeas: "Dealing with the change in means by finding the change in total sum.",
                techniques: "Use sums and averages, set up system with three unknowns.",
                errorProneSteps: "Setting up equations incorrectly (forgetting Ash adds one person).",
                solution: "A team of students is going to compete against a team of teachers in a trivia contest. The total number of students and teachers is $15$. Ash wants to join. If Ash plays with the students, the average age increases from $12$ to $14$. If Ash plays with the teachers, the average age decreases from $55$ to $52$. How old is Ash?",
                options: ["28", "29", "30", "31", "32"]
            },
            {
                id: "AMC10A_2025_P5",
                contest: "AMC 10A 2025",
                problemNumber: 5,
                difficulty: 30,
                topic: "algebra",
                answerIndex: 4,
                idealTime: { beginner: 180, intermediate: 60, experienced: 35 },
                tags: ["Sequences", "Arithmetic Progression", "Triangular Numbers"],
                coreIdeas: "Finding the endpoints of each 'valley'.",
                techniques: "Use triangular number sums; incremental block sizes.",
                errorProneSteps: "Miscounting position, remembering the index begins at $1$.",
                solution: "Consider the sequence of positive integers $$1,2,1,2,3,2,1,2,3,4,3,2,1,2,3,4,5,4,3,2,1,2,3,4,5,6,5,4,3,2,1,2,\\dots$$ What is the 2025th term?",
                options: ["5", "15", "16", "44", "45"]
            },
            {
                id: "AMC10A_2025_P6",
                contest: "AMC 10A 2025",
                problemNumber: 6,
                difficulty: 28,
                topic: "geometry",
                answerIndex: 2,
                idealTime: { beginner: 120, intermediate: 60, experienced: 25 },
                tags: ["Angle Chasing", "Equilateral Triangle", "Hexagon"],
                coreIdeas: "Drawing an accurate diagram and looking at the right triangle.",
                techniques: "Focus on one triangle at a time; use angle sum.",
                errorProneSteps: "Assuming hexagon is equiangular (leads to 120°).",
                solution: "In an equilateral triangle each interior angle is trisected by a pair of rays. The intersection of the interiors of the middle 20°-angle at each vertex is the interior of a convex hexagon. What is the degree measure of the smallest angle of this hexagon?",
                options: ["80", "90", "100", "110", "120"]
            },
            {
                id: "AMC10A_2025_P7",
                contest: "AMC 10A 2025",
                problemNumber: 7,
                difficulty: 18,
                topic: "algebra",
                answerIndex: 4,
                idealTime: { beginner: 90, intermediate: 40, experienced: 30 },
                tags: ["Polynomials", "Remainder Theorem", "System of Equations"],
                coreIdeas: "Applying the remainder theorem.",
                techniques: "Plugging and chugging once the theorem is directly applied.",
                errorProneSteps: "Mixing up linear expressions, arithmetic errors.",
                solution: "Suppose $a$ and $b$ are real numbers. When the polynomial $x^3+x^2+ax+b$ is divided by $x-1$, the remainder is $4$. When divided by $x-2$, the remainder is $6$. What is $b-a$?",
                options: ["14", "15", "16", "17", "18"]
            },
            {
                id: "AMC10A_2025_P8",
                contest: "AMC 10A 2025",
                problemNumber: 8,
                difficulty: 13,
                topic: "combo",
                answerIndex: 1,
                idealTime: { beginner: 120, intermediate: 60, experienced: 60 },
                tags: ["Logic Puzzle", "Truth Statements", "Casework"],
                coreIdeas: "Interpreting truth statements and implications.",
                techniques: "Test each scenario by number of true statements.",
                errorProneSteps: "Extracting the incorrect result.",
                solution: "Agnes writes the following four statements on a blank piece of paper.<ul><li>$\bullet$ At least one of these statements is true.</li><li>$\bullet$ At least two of these statements are true.</li><li>$\bullet$ At least two of these statements are false.</li><li>$\bullet$ At least one of these statements is false.</li></ul>Each statement is either true or false. How many false statements did Agnes write on the paper?",
                options: ["0", "1", "2", "3", "4"]
            },
            {
                id: "AMC10A_2025_P9",
                contest: "AMC 10A 2025",
                problemNumber: 9,
                difficulty: 45,
                topic: "algebra",
                answerIndex: 2,
                idealTime: { beginner: 600, intermediate: 240, experienced: 150 },
                tags: ["Functions", "Cubic", "Roots", "Transformations"],
                coreIdeas: "Recognizing that the condition is equivalent to asking how many $x$ satisfy $f(x)=25$.",
                techniques: "Calculate maxima and minima to count intersections.",
                errorProneSteps: "Attempting exact roots unnecessarily, applying calculus.",
                solution: "Let $f(x)=100x^3-300x^2+200x$. For how many real numbers $a$ does the graph of $y=f(x-a)$ pass through the point $(1,25)$?",
                options: ["1", "2", "3", "4", "more than 4"]
            },
            {
                id: "AMC10A_2025_P10",
                contest: "AMC 10A 2025",
                problemNumber: 10,
                difficulty: 32,
                topic: "geometry",
                answerIndex: 2,
                idealTime: { beginner: 150, intermediate: 90, experienced: 40 },
                tags: ["Area", "Circles", "Semicircle", "Pythagorean Theorem"],
                coreIdeas: "Using Pythagorean theorem to relate radii.",
                techniques: "Difference of areas, simplified using $R^2 - r^2 = 8^2$.",
                errorProneSteps: "Failing to divide area by two (semicircle vs circle).",
                solution: "A semicircle has diameter $\\overline{AB}$ and chord $\\overline{CD}$ of length $16$ parallel to $\\overline{AB}$. A smaller semicircle with diameter on $\\overline{AB}$ and tangent to $\\overline{CD}$ is cut from the larger semicircle. What is the area of the resulting figure, shown shaded?",
                options: ["$16\\pi$", "$24\\pi$", "$32\\pi$", "$48\\pi$", "$64\\pi$"]
            },
            {
                id: "AMC10A_2025_P11",
                contest: "AMC 10A 2025",
                problemNumber: 11,
                difficulty: 23,
                topic: "algebra",
                answerIndex: 4,
                idealTime: { beginner: 210, intermediate: 90, experienced: 45 },
                tags: ["Arithmetic Sequence", "Geometric Sequence", "Number Theory"],
                coreIdeas: "Expressing terms in sequences, solving for smallest integer $z$.",
                techniques: "Systematic trial and error with integer values for common ratio.",
                errorProneSteps: "Finding incorrect $z$ or summing wrong values.",
                solution: "The sequence $1, x, y, z$ is arithmetic. The sequence $1, p, q, z$ is geometric. Both sequences are strictly increasing and contain only integers, and $z$ is as small as possible. What is the value of $x+y+z+p+q$?",
                options: ["66", "91", "103", "132", "149"]
            },
            {
                id: "AMC10A_2025_P12",
                contest: "AMC 10A 2025",
                problemNumber: 12,
                difficulty: 35,
                topic: "combo",
                answerIndex: 3,
                idealTime: { beginner: 300, intermediate: 150, experienced: 90 },
                tags: ["Casework", "Constructive Counting", "Parity", "Primes"],
                coreIdeas: "The digit 2 is the only even prime, requiring casework.",
                techniques: "Constructive counting using 2 cases (contains 2 or doesn't).",
                errorProneSteps: "Failing to account for special digits position.",
                solution: "Carlos uses a $4$-digit passcode to unlock his computer. In his passcode, exactly one digit is even, exactly one (possibly different) digit is prime, and no digit is $0$. How many $4$-digit passcodes satisfy these conditions?",
                options: ["176", "192", "432", "464", "608"]
            },
            {
                id: "AMC10A_2025_P13",
                contest: "AMC 10A 2025",
                problemNumber: 13,
                difficulty: 36,
                topic: "geometry",
                answerIndex: 3,
                idealTime: { beginner: 240, intermediate: 120, experienced: 90 },
                tags: ["Geometric Series", "Area", "Similarity", "Infinite Sums"],
                coreIdeas: "Areas form an infinite geometric series with ratio $k^2$.",
                techniques: "Infinite geometric series sum formula.",
                errorProneSteps: "Using $k$ instead of $k^2$ for area ratio.",
                solution: "In the figure below, the outside square contains infinitely many squares, each of them with the same center and sides parallel to the outside square. The ratio of the side length of a square to the side length of the next inner square is $k$, where $0 < k < 1$. The spaces between squares are alternately shaded as shown in the figure. The area of the shaded portion of the figure is $64\\%$ of the area of the original square. What is $k$?",
                options: ["\\frac{3}{5}", "\\frac{16}{25}", "\\frac{2}{3}", "\\frac{3}{4}", "\\frac{4}{5}"]
            }
        ];

        // --- TOPIC MAPPING ---
        const curriculum = [
            { id: "algebra", title: "Algebra & Number Theory", problems: ["AMC10A_2025_P1", "AMC10A_2025_P2", "AMC10A_2025_P4", "AMC10A_2025_P5", "AMC10A_2025_P7", "AMC10A_2025_P11", "AMC10A_2025_P9"] },
            { id: "geometry", title: "Geometry & Spatial", problems: ["AMC10A_2025_P3", "AMC10A_2025_P6", "AMC10A_2025_P10", "AMC10A_2025_P13"] },
            { id: "combo", title: "Combinatorics & Logic", problems: ["AMC10A_2025_P8", "AMC10A_2025_P12"] }
        ];

        // --- AUTH & INIT ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginText').innerText = "User " + user.uid.substring(0,4);
                await loadProgress();
            }
            renderApp();
        });

        initAuth();

        // --- FIRESTORE LOGIC ---
        async function loadProgress() {
            if(!currentUser) return;
            const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data');
            try {
                const snap = await getDoc(userRef);
                if (snap.exists()) {
                    const data = snap.data();
                    solvedProblems = new Set(data.solved || []);
                    currentXP = data.xp || 0;
                    document.getElementById('userXp').innerText = `${currentXP} XP`;
                    document.getElementById('solvedCount').innerText = solvedProblems.size;
                } else {
                    await setDoc(userRef, { solved: [], xp: 0 });
                }
            } catch (e) { console.error("Load error:", e); }
        }

        async function saveProgress(problemId, difficulty) {
            if(!currentUser || solvedProblems.has(problemId)) return;
            
            solvedProblems.add(problemId);
            const xpGain = Math.max(10, difficulty);
            currentXP += xpGain;

            // UI Update
            document.getElementById('userXp').innerText = `${currentXP} XP`;
            document.getElementById('solvedCount').innerText = solvedProblems.size;
            renderApp();

            const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data');
            try {
                await updateDoc(userRef, {
                    solved: arrayUnion(problemId),
                    xp: currentXP
                });
            } catch (e) { console.error("Save error:", e); }
        }

        // --- RENDERING ---
        function renderApp() {
            renderGuide();
            lucide.createIcons();
            if(window.MathJax) MathJax.typesetPromise();
        }

        function getDiffClass(d) {
            if(d < 15) return 'easy';
            if(d < 30) return 'normal';
            return 'hard';
        }
        
        function getDiffLabel(d) {
            if(d < 15) return 'Easy';
            if(d < 30) return 'Normal';
            return 'Hard';
        }

        function renderGuide() {
            const container = document.getElementById('guideContent');
            container.innerHTML = curriculum.map(section => {
                const sectionProbs = section.problems.map(pid => problems.find(p => p.id === pid)).filter(Boolean);
                
                return `
                <div class="topic-section" id="topic-${section.id}">
                    <div class="topic-header">
                        <i data-lucide="book-open" class="topic-icon"></i>
                        ${section.title}
                    </div>
                    <div class="problem-list">
                        ${sectionProbs.map(p => {
                            const isSolved = solvedProblems.has(p.id);
                            const diffClass = getDiffClass(p.difficulty);
                            return `
                            <div class="problem-row" onclick="window.openDetail('${p.id}')">
                                <div class="status-icon ${isSolved ? 'solved' : ''}">
                                    ${isSolved ? '<i data-lucide="check-circle-2"></i>' : '<i data-lucide="circle"></i>'}
                                </div>
                                <div class="prob-info">
                                    <span class="prob-title">#${p.problemNumber} ${p.category}</span>
                                    <div class="prob-tags-col">
                                        ${p.tags.slice(0,3).map(t => `<span class="mini-tag">${t}</span>`).join('')}
                                    </div>
                                </div>
                                <div class="diff-badge ${diffClass}">
                                    ${getDiffLabel(p.difficulty)}
                                </div>
                                <div style="color:#444"><i data-lucide="chevron-right"></i></div>
                            </div>
                            `
                        }).join('')}
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- GLOBAL WINDOW FUNCTIONS ---
        window.switchView = (viewName) => {
            // Placeholder if you add more views later
        };

        window.scrollToTopic = (id) => {
            document.querySelectorAll('.guide-nav-item').forEach(el => el.classList.remove('active'));
            // logic to highlight clicked item would go here
            document.getElementById(`topic-${id}`)?.scrollIntoView({ behavior: 'smooth' });
        };

        window.openDetail = (id) => {
            const p = problems.find(x => x.id === id);
            if(!p) return;

            const optionsHtml = p.options.map((opt, i) => `
                <div class="opt-box" onclick="window.checkAnswer('${p.id}', ${i}, this)">
                    <span style="color:#666; font-weight:bold;">${String.fromCharCode(65+i)}</span>
                    <span>${opt}</span>
                </div>
            `).join('');

            document.getElementById('detailContent').innerHTML = `
                <div class="question-header">
                    <div>
                        <h2 style="margin:0; font-size: 1.8rem; margin-bottom: 5px;">Problem ${p.problemNumber}</h2>
                        <span style="color:#888;">${p.contest} • Difficulty ${p.difficulty}</span>
                    </div>
                    <div style="font-size:2.5rem; font-weight:800; color:#222;">#${p.problemNumber}</div>
                </div>

                <div class="question-box">${p.solution}</div>
                
                <div class="options-grid" id="optGrid">${optionsHtml}</div>

                <div class="analysis-dashboard">
                    <div class="info-card">
                        <h4><i data-lucide="clock"></i> Ideal Time</h4>
                        <div style="color: #ccc; font-size: 0.9rem;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Beginner:</span> <b>${p.idealTime.beginner}s</b></div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Intermediate:</span> <b>${p.idealTime.intermediate}s</b></div>
                            <div style="display:flex; justify-content:space-between;"><span>Experienced:</span> <b>${p.idealTime.experienced}s</b></div>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h4><i data-lucide="tag"></i> Core Ideas</h4>
                        <p style="color:#ccc; font-size:0.95rem; line-height:1.6;">${p.coreIdeas}</p>
                    </div>

                    <div class="info-card trap-card">
                        <h4><i data-lucide="alert-triangle"></i> Common Trap</h4>
                        <p style="color:#ccc; font-size:0.95rem; line-height:1.6;">${p.errorProneSteps}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('detailOverlay').classList.remove('hidden');
            lucide.createIcons();
            if(MathJax.typesetPromise) MathJax.typesetPromise();
        };

        window.checkAnswer = (pid, idx, el) => {
            const p = problems.find(x => x.id === pid);
            const grid = document.getElementById('optGrid');
            
            // Disable clicks
            grid.style.pointerEvents = 'none';
            grid.querySelectorAll('.opt-box').forEach(b => b.classList.add('disabled'));

            if(idx === p.answerIndex) {
                el.classList.add('correct');
                saveProgress(pid, p.difficulty);
            } else {
                el.classList.add('incorrect');
                grid.children[p.answerIndex].classList.add('correct');
            }
        };

        window.closeDetail = () => {
            document.getElementById('detailOverlay').classList.add('hidden');
        };

    </script>
</body>
</html>
